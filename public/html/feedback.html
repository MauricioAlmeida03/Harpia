<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Harpia | Feedback</title>

    <link href='https://fonts.googleapis.com/css?family=Julius Sans One' rel='stylesheet'>
    <link rel="stylesheet" href="../css/style-feedback.css">
    <link rel="icon" href="./assets/icon/favicon2.ico">
    <script src="../js/sessao.js"></script>
</head>


<body onload="validarSessao(), atualizarFeed()" style="background-color: #161618;">

    <body onload="validarSessao()">
        <div class="header">
            <div class="container">
                <a href="../index.html">
                    <div id="logo-harpia">
                        <img src="../assets/LogoType.svg" alt="logo">
                    </div>
                </a>
                <ul class="navbar">
                    <li>
                        <a href="../index.html">Início</a>
                    </li>
                    <li>
                        <a href="./quemSomos.html">Quem Somos</a>
                    </li>
                    <li>
                        <a href="./fomeZero.html">Fome Zero</a>
                    </li>
                    <li>
                        <a href="./cardapio.html">Cardápio</a>
                    </li>
                    <li>
                        <a href="./reservas.html">Reservas</a>
                    </li>
                    <li class="agora">
                        <a href="./avaliacoes.html">Avaliações</a>
                    </li>
                    <li class="loginHeader">
                        <a href="../login.html">Login</a>
                    </li>
                    <li class="cadastro">
                        <a href="../cadastro.html">Cadastro</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="dash-right">
            <div class="container">
                <h1>Avalie nosso restaurante!!</h1>
                <div class="div-form">
                    <form id="form_postagem" method="post" onsubmit="return publicar()">
                        <label>
                            <div class="estrelasBox">
                                <ul class="avaliacao">
                                    <li class="star-icon ativo" data-avaliacao="1"></li>
                                    <li class="star-icon" data-avaliacao="2"></li>
                                    <li class="star-icon" data-avaliacao="3"></li>
                                    <li class="star-icon" data-avaliacao="4"></li>
                                    <li class="star-icon" data-avaliacao="5"></li>
                                </ul>
                            </div>
                        </label>
                        <br>

                        <div class="hello">
                            <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
                        </div>
                        <label>
                            Título:
                            <br>
                            <input name="titulo" id="titulo" maxlength="100" type="text">
                        </label>

                        <br>
                        <br>
                        <label>
                            Descrição (máximo de 250 caracteres):
                            <br>
                            <textarea name="Feedback" id="textarea_Feedback" maxlength="250" rows="5"></textarea>
                        </label>
                        <br>
                        <br>
                        <button>Enviar</button>
                    </form>
                </div>
            </div>
        </div>
    </body>

    <script>

        let selectedRating = null;
        var quantidadeEstrelas = 0;
        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

        function limparFormulario() {
            document.getElementById("form_postagem").reset();
        }

        function publicar() {
            var idUsuario = sessionStorage.ID_USUARIO;

            var corpo = {
                titulo: form_postagem.titulo.value,
                Feedback: form_postagem.Feedback.value,
                avaliacao: selectedRating
            }

            if (!corpo.titulo) {
                alert("Faltou título");
            } else if (!corpo.Feedback) {
                alert("Faltou descrição");
            } else if (!corpo.avaliacao) {
                alert("Faltou estrela");
            } else {
                fetch(`/avisos/publicar/${idUsuario}`, {
                    method: "post",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(corpo)
                }).then(function (resposta) {

                    console.log("resposta: ", resposta);

                    if (resposta.ok) {
                        window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                        window.location = "./feedback.html";
                        limparFormulario();
                        finalizarAguardar();
                    } else if (resposta.status == 404) {
                        window.alert("Deu 404!");
                    } else {
                        throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                    }
                }).catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                    finalizarAguardar();
                });

            }


            return false;

        }

        document.addEventListener('DOMContentLoaded', function () {
            var stars = document.querySelectorAll('.star-icon');
            stars.forEach(function (star) {
                star.addEventListener('click', function (eventoClick) {
                    var classStar = eventoClick.target.classList;
                    if (!classStar.contains('ativo')) {
                        stars.forEach(function (star) {
                            star.classList.remove('ativo');
                        });
                        classStar.add('ativo');
                        quantidadeEstrelas = parseInt(eventoClick.target.getAttribute('data-avaliacao'));
                        // Atualiza a avaliação selecionada
                        console.log(quantidadeEstrelas);
                        selectedRating = quantidadeEstrelas;
                    }
                });
            });
        });

    </script>